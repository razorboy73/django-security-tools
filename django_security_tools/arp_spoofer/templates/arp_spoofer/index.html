{% extends "base.html" %}

{% block title %}ARP Spoofer{% endblock %}

{% block content %}
<div class="container">
    <h1>ARP Spoofer</h1>
    <p>
        ARP spoofing is a technique by which an attacker sends fake Address Resolution Protocol (ARP) messages
        onto a local area network. This is often done to link the attackerâ€™s MAC address with the IP address
        of a legitimate computer or server on the network, enabling the attacker to intercept, modify, or block data.
    </p>
    <p>
        This application demonstrates ARP spoofing for educational and security testing purposes only.
        Unauthorized use is strictly prohibited.
    </p>

    <!-- Step-by-step Instructions -->
    <div class="instructions mt-4">
        <h2>How to Use the ARP Spoofer</h2>
        <ol>
            <li><strong>Detect Gateway:</strong> Click "Detect Gateway" to find the IP and MAC address of your network gateway.</li>
            <li><strong>Scan Network:</strong> Click "Scan Network" to identify devices on your network.</li>
            <li><strong>Select Target:</strong> Choose a target device from the scan results for spoofing.</li>
            <li><strong>Start Spoofing:</strong> Click "Start Spoofing" to initiate spoofing.</li>
            <li><strong>Stop Spoofing:</strong> Click "Stop Spoofing" to end the spoofing process.</li>
        </ol>
        <p class="text-danger"><strong>Warning:</strong> Use this tool responsibly and only in environments where you have explicit permission to test.</p>
    </div>

    <!-- Detect Gateway -->
    <form method="post">
        {% csrf_token %}
        <button type="submit" name="detect_gateway" class="btn btn-primary">Detect Gateway</button>
    </form>
    {% if gateway_info %}
        <div class="alert alert-info mt-3">
            <h4>Gateway Information</h4>
            <p><strong>IP Address:</strong> {{ gateway_info.ip }}</p>
            <p><strong>MAC Address:</strong> {{ gateway_info.mac }}</p>
        </div>
    {% endif %}

    <!-- Scan Network -->
    <div class="mt-4">
        <form method="post">
            {% csrf_token %}
            <button type="submit" name="scan_network" class="btn btn-secondary">Scan Network</button>
        </form>
        {% if scan_results %}
            <div class="mt-3">
                <h4>Network Scan Results</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>MAC Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in scan_results %}
                        <tr>
                            <td>{{ device.ip }}</td>
                            <td>{{ device.mac }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>

    <!-- Spoofing Controls -->
    {% if spoofing_status %}
    <form method="post" name="stop_spoofing">
        {% csrf_token %}
        <button type="submit" name="stop_spoofing" class="btn btn-danger">Stop Spoofing</button>
    </form>
    <div class="alert alert-info mt-3">
        <strong>Spoofing is active.</strong> Port forwarding is enabled.
        <div id="packet-counter">Packets sent: 0</div>
        <div id="packet-indicator" style="width: 20px; height: 20px; background-color: red; animation: flash 1s infinite;"></div>
    </div>
{% else %}
    <form method="post" class="mt-3">
        {% csrf_token %}
        <div class="form-group">
            <label for="target">Select Target for Spoofing:</label>
            <select name="target" id="target" required>
                {% for device in scan_results %}
                    <option value="{{ device.ip }}|{{ device.mac }}">{{ device.ip }} - {{ device.mac }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" name="start_spoofing" class="btn btn-primary">Start Spoofing</button>
    </form>
{% endif %}
</div>

<script>
    let packetCounterInterval;

    function updatePacketCounter() {
        fetch("/arp_spoofer/get_packet_count/")
            .then(response => response.json())
            .then(data => {
                const counterElement = document.getElementById("packet-counter");
                if (counterElement) {
                    counterElement.textContent = `Packets sent: ${data.packet_count}`;
                }
            })
            .catch(console.error);
    }
    
    function startPacketCounter() {
        packetCounterInterval = setInterval(updatePacketCounter, 1000);
    }
    
    function stopPacketCounter() {
        if (packetCounterInterval) {
            clearInterval(packetCounterInterval);
        }
    }
    
    document.addEventListener("DOMContentLoaded", () => {
        const spoofingActive = {{ spoofing_status|yesno:"true,false" }};
        if (spoofingActive === "true") {
            startPacketCounter();
        }
    });
    
    document.querySelector('form[name="stop_spoofing"]')?.addEventListener("submit", function (event) {
        event.preventDefault();
        stopPacketCounter();
        fetch("/", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: "stop_spoofing=1",
        }).then(() => {
            location.reload();
        });
    });
</script>

<style>
    @keyframes flash {
        0% { background-color: red; }
        50% { background-color: green; }
        100% { background-color: red; }
    }
</style>
{% endblock %}
